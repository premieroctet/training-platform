import { Image } from "@chakra-ui/image";
import ChapterHeading from "@/components/mdx/ChapterHeading";
import { MdCheckCircle, MdCancel } from "react-icons/md";

<Slides>

<ChapterHeading title="üìêü§ì API CRUD avec NestJS" backgroundColor="#6c5ce7" />

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

#### Le framework NestJS

**NestJS** est un framework TypeScript permettant de d√©velopper des backends : https://docs.nestjs.com

- Initialiser votre projet :

```bash
nest new nestjs-training-ts
‚ö°  We will scaffold your app in a few seconds..
```

- Lancer le serveur

```
yarn start:dev
```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

#### ORM TypeORM

Installer TypeORM (ORM TypeScript)

```bash
yarn add @nestjs/typeorm typeorm@0.2 pg # ou mysql2
```

https://typeorm.io

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

#### Configurer TypeORM

[Ajouter le module TypeORM](https://docs.nestjs.com/techniques/database#typeorm-integration) √† votre `app.module.ts`

```typescript
import { TypeOrmModule } from "@nestjs/typeorm";

@Module({
  imports: [
    TypeOrmModule.forRoot({
      type: "postgres",
      host: "localhost",
      port: 5432,
      username: "nestjs-training-ts",
      password: "nestjs-training-ts",
      database: "nestjs-training-ts",
      entities: [__dirname + "/**/*.entity{.ts,.js}"],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

Exemple de Dockerfile pour la base de donn√©es :

```yaml
version: "3.6"

services:
  postgres:
    image: postgres:14
    restart: always
    environment:
      POSTGRES_USER: nestjs-training-ts
      POSTGRES_PASSWORD: nestjs-training-ts
      POSTGRES_DB: nestjs-training-ts
    ports:
      - 5432:5432
    volumes:
      - postgresql:/var/lib/postgresql
      - postgresql_data:/var/lib/postgresql/data

volumes:
  postgresql:
  postgresql_data:
```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

G√©n√©rez une nouvelle ressource `posts` :

- REST
- Sans endpoints CRUD

```bash
nest generate resource
```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

Cr√©ez une entit√© `posts/post.entity.ts` :

```typescript
import { Column, Entity, PrimaryGeneratedColumn } from "typeorm";

@Entity()
export class Post {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  title: string;

  @Column()
  content: string;
}
```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

#### NestJS Crud

[nestjsx/crud](https://github.com/nestjsx/crud) permet de g√©n√©rer automatiquement vos routes REST CRUD √† partir de votre mod√®le

- Ajoutez `@nestjsx/crud` √† votre projet :

```bash
yarn add @nestjsx/crud class-transformer class-validator @nestjsx/crud-typeorm
```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

Modifiez votre service :

```
// posts.service.ts

import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { TypeOrmCrudService } from '@nestjsx/crud-typeorm';
import { Post } from './post.entity';

@Injectable()
export class PostsService extends TypeOrmCrudService<Post> {
  constructor(@InjectRepository(Post) repo) {
    super(repo);
  }
}

```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

Modifiez votre contr√¥leur :

```
// posts.controller.ts

import { Controller } from '@nestjs/common';
import { CrudController, Crud } from '@nestjsx/crud';
import { Post } from './post.entity';
import { PostsService } from './posts.service';

@Crud({
  model: {
    type: Post,
  },
})
@Controller('posts')
export class PostsController implements CrudController<Post> {
  constructor(public service: PostsService) {}
}
```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

Modifiez votre module :

```
// posts.module.ts

import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';

import { Post } from './post.entity';
import { PostsService } from './posts.service';
import { PostsController } from './posts.controller';

@Module({
  imports: [TypeOrmModule.forFeature([Post])],
  providers: [PostsService],
  controllers: [PostsController],
})
export class PostsModule {}

```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

Constatez les nouvelles routes :

```
[Nest] - LOG [RoutesResolver] AppController {/}: +23ms
[Nest] - LOG [RouterExplorer] Mapped {/, GET} route +2ms
[Nest] - LOG [RoutesResolver] PostsController {/posts}: +1ms
[Nest] - LOG [RouterExplorer] Mapped {/posts/:id, GET} route +1ms
[Nest] - LOG [RouterExplorer] Mapped {/posts, GET} route +0ms
[Nest] - LOG [RouterExplorer] Mapped {/posts, POST} route +1ms
[Nest] - LOG [RouterExplorer] Mapped {/posts/bulk, POST} route +0ms
[Nest] - LOG [RouterExplorer] Mapped {/posts/:id, PATCH} route +0ms
[Nest] - LOG [RouterExplorer] Mapped {/posts/:id, PUT} route +1ms
[Nest] - LOG [RouterExplorer] Mapped {/posts/:id, DELETE} route +0ms
[Nest] - LOG [NestApplication] Nest application successfully started +2ms
```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

#### OpenAPI

G√©n√©rez une sp√©c OpenAPI avec le module [@nestjs/swagger](https://docs.nestjs.com/openapi/introduction)

```
yarn add @nestjs/swagger swagger-ui-express
```

Activez le module dans le fichier `main.ts` :

```
const config = new DocumentBuilder()
    .setTitle('API Doc')
    .setVersion('1.0')
    .build();

const document = SwaggerModule.createDocument(app, config);
SwaggerModule.setup('api/doc', app, document);
```

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

#### OpenAPI

Vous pouvez d√©sormais acc√©der :

- √Ä l'interface sur **/api/doc**
- Au sch√©ma JSON sur **/api/doc-json**

Nous allons maintenant utiliser ce sch√©ma **pour g√©n√©rer des types c√¥t√© client !**

---

<SlideHeader slideTitle="üìêü§ì API CRUD avec NestJS" />

#### Front : Next.js

Nous allons d√©sormais ajouter un front avec [Next.js](https://nextjs.org/) :

```
yarn create next-app --typescript
```

Puis utiliser [swagger-typescript-api](https://github.com/acacode/swagger-typescript-api) pour g√©n√©rer nos types :

```
yarn add --dev swagger-typescript-api
```

Enfin, g√©n√©rez vos types et votre client d'API :

```json
  "scripts": {
    "get-types": "swagger-typescript-api --axios -p http://back/api/doc-json -o ./core -n api.ts"
  },
```

</Slides>
