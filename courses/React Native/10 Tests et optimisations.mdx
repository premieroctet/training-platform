import { MdCheckCircle } from "react-icons/md";

<Slides>

<ChapterHeading
  title="Tests E2E 🤖"
  imgSrc={require("../assets/backgrounds/atom-wallpaper.jpg").default.src}
/>

---

<SlideHeader slideTitle="Tests E2E" />

#### Les test E2E (end-to-end) <Icon as={MdCheckCircle} color="green.300" />

- Permet de tester une application dans sa **globalité**
- Exécute les tests dans **un simulateur ou device** 📱
- Tests qui reflètent le plus **la réalité**

---

<SlideHeader slideTitle="Tests E2E" />

#### Detox 🥤

- Librairie de tests **E2E pour React Native**
- Développé par Wix
- https://github.com/wix/Detox

---

<SlideHeader slideTitle="Tests E2E" />

#### Detox

<List fontSize="1em" textAlign="left" m="0.6em 0" padding="12px 0">
  <ListItem>
    <ListIcon as={MdCheckCircle} color="green.300" />
    Cross platform (Android / iOS)
  </ListItem>
  <ListItem>
    <ListIcon as={MdCheckCircle} color="green.300" />
    Exécutable dans un CI (Travis, Bitrise)
  </ListItem>
  <ListItem>
    <ListIcon as={MdCheckCircle} color="green.300" />
    Gère automatiquement les transitions :
  </ListItem>
  <ListItem >
    <ListIcon as={MdCheckCircle} color="transparent" />
    Requêtes réseaux, animations, timers, RN Bridge…
  </ListItem>

</List>

---

<SlideHeader slideTitle="Test E2E" />

#### Installer les outils Detox

`brew tap wix/brew`

`brew install applesimutils`

`yarn global add detox-cli`

---

<SlideHeader slideTitle="Test E2E" />

#### Ajouter Detox à votre projet RN

`yarn add --dev detox`

---

<SlideHeader slideTitle="Test E2E" />

#### Configurer Detox ⚙️

- Ajoutez à votre **package.json** :

<Box fontSize="0.7em" >

```json
{
  "detox": {
    "test-runner": "jest",
    "configurations": {
      "ios.sim.debug": {
        "binaryPath": "ios/build/Build/Products/Debug-iphonesimulator/app.app",
        "build": "xcodebuild -workspace ios/app.xcworkspace -configuration Debug -sdk iphonesimulator -scheme app -derivedDataPath ios/build",
        "type": "ios.simulator",
        "name": "iPhone X"
      }
    }
  }
}
```

</Box>

---

<SlideHeader slideTitle="Test E2E" />

#### Configurer Detox ⚙️

- Bootstrappez les tests (création d'un exemple de test) :

`detox init -r jest`

---

<SlideHeader slideTitle="Test E2E" />

#### Build et lancement des tests 🎈

`detox build detox test`

---

<SlideHeader slideTitle="Test E2E" />

#### Boite à outils de Detox 🧰

<List fontSize="1em" textAlign="left" m="0.6em 0" padding="12px 0">
  <ListItem>👉 Les actions</ListItem>
  <ListItem>🎯 Les sélecteurs (Matchers)</ListItem>
  <ListItem>
    <ListIcon as={MdCheckCircle} color="green.300" />
    Les validateurs (Expectations)
  </ListItem>
</List>

---

<SlideHeader slideTitle="Test E2E" />

#### Boite à outils de Detox 🧰

- 👉 **Les actions**"
  - Permet d'interagir avec les élements
    - tap()
    - scroll()
    - swipe()
    - …
  - [APIRef.ActionsOnElement.md](https://github.com/wix/Detox/blob/master/docs/APIRef.ActionsOnElement.md)

---

<SlideHeader slideTitle="Test E2E" />

#### Boite à outils de Detox 🧰

- 🎯 **Les sélecteurs** (Matchers)
  - Permet de sélectionner des élements
    - by.id() (depuis un attribut testID)
    - by.text()
    - by.label()
    - …
  - [APIRef.Matchers.md](https://github.com/wix/Detox/blob/master/docs/APIRef.Matchers.md)

---

<SlideHeader slideTitle="Test E2E" />

#### Boite à outils de Detox 🧰

- ✅ **Les validateurs** (Expectations)
  - Permet de valider l'existence d'un élement
    - toBeVisible()
    - toHaveText()
    - toNotExist()
    - …
  - [APIRef.Expect.md](https://github.com/wix/Detox/blob/master/docs/APIRef.Expect.md)

---

<SlideHeader slideTitle="Test E2E" />

#### Exemple de test

```js
describe("Login flow", () => {
  it("should login successfully", async () => {
    await device.reloadReactNative();
    await expect(element(by.id("email"))).toBeVisible();

    await element(by.id("email")).typeText("john@example.com");
    await element(by.id("password")).typeText("123456");
    await element(by.text("Login")).tap();

    await expect(element(by.text("Welcome"))).toBeVisible();
    await expect(element(by.id("email"))).toNotExist();
  });
});
```

---

<SlideHeader slideTitle="Mise en pratique : Test avec Detox" />

#### 📐🤓 **Detox** : mise en pratique

- Créez une app RN 0.60
- Installez Detox
- Créez un écran d'onboarding avec
  [react-native-onboarding-swiper](https://github.com/jfilter/react-native-onboarding-swiper)
- Testez les différents écrans avec le swipe

---

<ChapterHeading
  title="Tests unitaires 🤖"
  imgSrc={require("../assets/backgrounds/tests.jpg").default.src}
/>

---

<SlideHeader slideTitle="Tests unitaires" />

#### Tests unitaires avec Jest ✅

- Librairie de tests et mock créée par Facebook
- https://facebook.github.io/jest/

- Par défaut dans React Native :

`yarn test`

---

<SlideHeader slideTitle="Tests unitaires" />

#### Jest : exemple

```js
export const arrayToMap = (items) => {
  let result = {};

  items.forEach((item) => {
    result[item.id] = item;
  });

  return result;
};
```

---

<SlideHeader slideTitle="Tests unitaires" />

#### Jest : exemple

```js
import { arrayToMap } from "./transformers";

describe("arrayToMap", () => {
  it("should returns an object with key ids", () => {
    const items = [
      { id: 1, name: "Tom" },
      { id: 2, name: "Jim" },
    ];

    expect(arrayToMap(items)).toStrictEqual({
      1: { id: 1, name: "Tom" },
      2: { id: 2, name: "Jim" },
    });
  });
});
```

---

<SlideHeader slideTitle="Tests unitaires" />

#### Bonnes pratiques 🤓

- Suffixez vos fichiers de tests par **\*.test.js**
- Mettez votre fichier de test **au même niveau** que le fichier testé

---

<ChapterHeading
  title="Tests fonctionnels 🤖"
  imgSrc={require("../assets/backgrounds/spacex-launch.jpg").default.src}
/>

---

<SlideHeader slideTitle="Tests fonctionnels" />

#### **Tests fonctionnels avec React Native Testing Library** ✅

- Remplace Enzyme
- Permet de rendre et manipuler des composants React
- https://www.native-testing-library.com/

`yarn add @testing-library/react-native`

---

<SlideHeader slideTitle="Tests fonctionnels" />

#### React Native Testing Library : exemple

```js
const Login = () => {
  const [name, setUser] = useState("");
  const [show, setShow] = useState(false);

  return (
    <Container>
      <SearchInput value={name} onChangeText={setUser} testID="input" />
      <Button
        title="Login"
        testID="button"
        onPress={() => {
          setShow(!show);
        }}
      />
      {show && <Text testID="printed-username">{name}</Text>}
    </Container>
  );
};
```

---

<SlideHeader slideTitle="Tests fonctionnels" />

#### React Native Testing Library : exemple

```js
import React from "react";
import { fireEvent, render } from "@testing-library/react-native";
import Login from "./Login";

test("test login", async () => {
  const { getByTestId, queryByTestId } = render(<Login />);

  const username = "Baptiste";

  const input = getByTestId("input");
  fireEvent.changeText(input, username);

  const button = getByTestId("button");
  fireEvent.press(button);

  expect(queryByTestId("printed-username")).toBeTruthy();
  expect(getByTestId("printed-username").props.children).toBe(username);
});
```

---

<SlideHeader slideTitle="Tests fonctionnels" />

#### Mock de module 1/2

```js
// users.js
import axios from "axios";

class Users {
  static all() {
    return axios.get("/users.json").then((resp) => resp.data);
  }
}

export default Users;
```

---

<SlideHeader slideTitle="Tests fonctionnels" />

#### Mock de module 2/2

```js
// users.test.js
import axios from "axios";
import Users from "./users";

jest.mock("axios");

test("should fetch users", () => {
  const users = [{ name: "Bob" }];
  const resp = { data: users };
  axios.get.mockResolvedValue(resp);

  return Users.all().then((data) => expect(data).toEqual(users));
});
```

---

<SlideHeader slideTitle="Mise en pratique : tests fonctionnels" />

#### 📐🤓 **Tests fonctionnels** : mise en pratique

- Créez un composant qui récupère une quote de Chuck Noris selon un mot donné
- https://api.chucknorris.io/jokes/search?query=hello
- Testez votre composant sans mock
- Mockez l'appel HTTP

---

<ChapterHeading
  title="Optimiser son code ✨"
  imgSrc={require("../assets/backgrounds/architecture.jpg").default.src}
/>

---

<SlideHeader slideTitle="Optimiser son code" />

#### Plusieurs leviers 🧞‍♂️

- 👉 React.memo() / PureComponent
- 👉 useMemo()
- 👉 Définir les key

---

<SlideHeader slideTitle="Optimiser son code" />

#### React.memo() / PureComponent ✋

- Permet de bloquer le rendu si les props ne changent pas :

```jsx
import React, { PureComponent, memo } from "react";

// Functionnal component
const UserList = memo((props) => {
  // jsx
});

// Class component
class UserList extends PureComponent {}
```

---

<SlideHeader slideTitle="Optimiser son code" />

#### useMemo() 🔄

- https://fr.reactjs.org/docs/hooks-reference.html#usememo
- 🎣 Hook : utilisable uniquement dans un composant fonctionnel
- Met en cache le résulat d'une fonction (selon ses paramètres)

```jsx
import React, { useMemo } from "react";

const UserList = memo(({ users }) => {
  const filteredUsers = useMemo(() => filterUsers(users), [users]);
});
```

---

<SlideHeader slideTitle="Optimiser son code" />

#### Définir les keys 🔑

- Il est important de définir l'attribut key dans des structures itératives
- Permet à React d'éviter de recréer des composants lors de re-render

```jsx

import React;

const UserList = ({users}) => {
  return <>{users.map(user => <UserItem key={user.id} user={user} />)}</>
};
```

---

<ChapterHeading
  title="Profiler son app 🔍"
  imgSrc={require("../assets/backgrounds/react-native-splash.jpg").default.src}
/>

---

<SlideHeader slideTitle="Profiler son app" />

#### React Native Debugger 🐞

<Image src={require("./assets/profiler.png").default.src} />

---

<SlideHeader slideTitle="Profiler son app" />

#### React Native Debugger 🐞

- React DevTools 3 disponible dans
  [react-native-debugger](https://github.com/jhen0409/react-native-debugger)
- React DevTools 4 disponible
  [qu'à partir de RN 0.62](https://reactjs.org/blog/2019/08/15/new-react-devtools.html#which-versions-of-react-are-supported)
  😕

---

<SlideHeader slideTitle="Profiler son app" />

#### Commit & Component Graph 🐞

<Image src={require("./assets/profiler2.png").default.src} />

---

<SlideHeader slideTitle="Profiler son app" />

#### Commit & Component Graph 🐞

- Code couleur :
  - ✅ Vert : Opération peu coûteuse
  - 🔶 Orange : Opération coûteuse
  - ◻️ Gris : Aucun rendu

<Image src={require("./assets/profiler3.png").default.src} />

---

<SlideHeader slideTitle="Profiler son app" />

#### Cycle de vie d'un render 🔁

- **Render phase** : Création des élements avec React.createElement
- **Reconciliation phase** : comparaison des Virtual DOM
- **Commit phase** : màj du DOM

---

<SlideHeader slideTitle="Profiler son app" />

#### Commit Graph 🎯

- Un **commit** est une màj du DOM (re-render) :

<Image src={require("./assets/profiler4.png").default.src} />

---

<SlideHeader slideTitle="Profiler son app" />

#### Components Graph 🧩

- À chaque **commit** correspond un **Components Graph**

<Image src={require("./assets/profiler5.png").default.src} />

---

<SlideHeader slideTitle="Mise en pratique : Profiling" />

#### 📐🤓 **Profiling** : démo

- Repérer des rendus inutile grâce au Profiler

<Image src={require("./assets/profiler6.png").default.src} />

---

<ChapterHeading
  title="Créer un module natif 📲"
  imgSrc={require("../assets/backgrounds/cockpit.jpg").default.src}
/>

---

<SlideHeader slideTitle="Créer un Native Module" />

#### Native Module ? 📲

- Permet d'exposer à RN des fonctionnalités iOS / Android
- Communique via le Bridge React Native
- Doit être créer dans Xcode (iOS) et Android Studio

---

<SlideHeader slideTitle="Créer un Native Module" />

#### Native Module avec iOS 🍏

- Fichier Objective C implémentant **le protocole RCTBridgeModule**
- La classe doit inclure le macro **RCT_EXPORT_MODULE()**
- Les méthodes doivent être exposer via **RCT_EXPORT_METHOD()**
- https://facebook.github.io/react-native/docs/native-modules-ios

<Image src={require("./assets/native1.png").default.src} />

---

<SlideHeader slideTitle="Créer un Native Module" />

#### Native Module avec iOS 🍏

```objectivec
// ios/Device.h
#import <React/RCTBridgeModule.h>

@interface Device : NSObject <RCTBridgeModule>

@end
```

```objectivec
// ios/Device.m
#import "Device.h"

@implementation Device

RCT_EXPORT_MODULE();

@end
```

---

<SlideHeader slideTitle="Créer un Native Module" />

#### Native Module avec iOS 🍏

- Appel de la méthode côté JS :

```jsx
import React, { useState } from "react";
import { NativeModules, Text } from "react-native";
import { Container } from "../../layout/elements";

const DeviceInfo = () => {
  const [device, setDevice] = useState();

  NativeModules.Device.getDeviceName((err, name) => {
    if (!err) {
      setDevice(name);
    }
  });

  return <Container>{device && <Text>{device}</Text>}</Container>;
};

export default DeviceInfo;
```

---

<SlideHeader slideTitle="Mise en pratique : Native Module" />

#### 📐🤓 **Native Module** : mise en pratique

- Créer un module natif sur iOS
- Exposez le nom du device
- Affichez le nom du device dans RN

---

<SlideHeader slideTitle="Créer un Native Module" />

#### Native Module avec Android 🤖

- Classe Java étendant **la classe ReactContextBaseJavaModule**
- Les méthodes doivent avoir l'annotation **@ReactMethod** pour être exposés
- https://facebook.github.io/react-native/docs/native-modules-android

---

<SlideHeader slideTitle="Créer un Native Module" />

#### Native Module avec Android : DeviceModule.java

```js
public class DeviceModule extends ReactContextBaseJavaModule {
   public DeviceModule(ReactApplicationContext reactContext) {
       super(reactContext);
   }
   @Override
   public String getName() {
       return "Device";
   }
   @ReactMethod
   public void getDeviceName(Callback cb) {
       try{
           cb.invoke(null, android.os.Build.MODEL);
       }catch (Exception e){
           cb.invoke(e.toString(), null);
       }
   }
}
```

---

<SlideHeader slideTitle="Créer un Native Module" />

#### Native Module avec Android : DevicePackage.java

```js
public class DevicePackage implements ReactPackage {
  @Override
  public List<ViewManager> createViewManagers(ReactApplicationContext reactContext) {
    return Collections.emptyList();
  }
  @Override
  public List<NativeModule> createNativeModules(
          ReactApplicationContext reactContext) {
    List<NativeModule> modules = new ArrayList<>();
    //We import the module file here
    modules.add(new DeviceModule(reactContext));

    return modules;
  }
  // Backward compatibility
  public List<Class<? extends JavaScriptModule>> createJSModules() {
    return new ArrayList<>();
  }
}
```

---

<SlideHeader slideTitle="Créer un Native Module" />

#### Importer le package dans le MainApplication

```js
@Override
protected List<ReactPackage> getPackages() {
  @SuppressWarnings("UnnecessaryLocalVariable")
  List<ReactPackage> packages = new PackageList(this).getPackages();

  // Here
  packages.add(new DevicePackage());
  return packages;
}
```

---

<SlideHeader slideTitle="Créer un Native Module" />

#### Native Module avec Android

- Appel de la méthode côté JS :

```jsx
import React, { useState } from "react";
import { NativeModules, Text } from "react-native";
import { Container } from "../../layout/elements";

const DeviceInfo = () => {
  const [device, setDevice] = useState();

  NativeModules.Device.getDeviceName((err, name) => {
    if (!err) {
      setDevice(name);
    }
  });

  return <Container>{device && <Text>{device}</Text>}</Container>;
};

export default DeviceInfo;
```

</Slides>
