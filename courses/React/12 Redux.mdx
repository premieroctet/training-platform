import { Image } from "@chakra-ui/image";
import ChapterHeading from "@/components/mdx/ChapterHeading";
import { MdCheckCircle, MdCancel } from "react-icons/md";

<Slides title="Redux" course="Formation React">

<ChapterHeading title="Redux" />

---

<SlideHeader slideTitle="Redux" />

<Image src={require("./assets/redux.png").default.src} w="50%" m="md" />

- https://github.com/reactjs/redux
- Librairie principale pour impl√©menter le paradigme Flux

---

<SlideHeader slideTitle="Complexit√© d'une application" />

#### Complexit√© d'une application

- **Couplage** : une vue d√©pend d'un ou plusieurs mod√®les
- **Mise √† jour laborieuse** : n√©cessite l'ajout/suppression de listener
- **Effets de bord**, donn√©es erron√©es
- **Stockage des donn√©es** difficile

---

<SlideHeader slideTitle="Exemple : Backbone" />
<Image
  src={require("./assets/backbone-example.png").default.src}
  alignSelf="center"
  width="40%"
/>

---

<SlideHeader slideTitle="Flux, un pattern propos√© par Facebook" />

##### **Redux** √† la rescousse ‚úåÔ∏è

- Une architecture pour g√©rer les flux de donn√©es
- Impose un flux de donn√©e **unidirectionel**
- Permet de **d√©samorcer la complexit√©** d'une application
- Rend le code plus **clair, lisible et scalable**

---

<SlideHeader slideTitle="Redux : fonctionnement" />

<Image src={require("./assets/redux-schema.svg").default.src} />

---

<SlideHeader slideTitle="Les actions" />

#### Les actions

- Les actions d√©finissent **l'API de votre application** , elles sont
  "dispatch√©es"
- Elles traduisent une volont√© d'interaction (r√©cup√©ration de donn√©es, click ‚Ä¶)
- Ce sont des objets JavaScript comportant **un attribut type** et des donn√©es
  facultatives :

```js
{ type: 'DELETE_ITEM', itemId: 1234 }
{ type: 'ADD_ITEM', itemId: { name: 'Item 1' } }
```

---

<SlideHeader slideTitle="Les reducers" />

#### Les reducers

- C'est une fonction qui prend une action et retourne un nouveau state
- Ils indiquent comment une action doit modifier le store¬†:

```js
const reducer = (state, action) => {
  switch (action.type) {
    case "ADD_MESSAGE":
      return {
        entities: [
          ...state.entities,
          { body: action.message, username: action.username },
        ],
      };

    default:
      return state;
  }
};
```

---

<SlideHeader slideTitle="Le dispatch" />

#### Le dispatch

- Responsable de **l'envoi d'actions** aux reducers
- Ces actions proviennent le plus souvent **d'interactions utilisateurs**
  (click, submit‚Ä¶)

---

<SlideHeader slideTitle="Le store" />

#### Le store

- Contient les donn√©es de votre application
- Une action **modifie** le store via les **reducers**
- Le store **notifie** les composants lorsque les donn√©es ont √©t√© mise √† jour

---

<SlideHeader slideTitle="Les vues" />

#### Les vues

- Les donn√©es du store **sont affich√©es** dans les vues
- Une vue **√©coute un store** : √† chaque changement dans un store la vue est
  **mise √† jour** avec les nouvelles donn√©es
- Le flux de donn√©es est toujours dans **le m√™me sens** :

<List fontSize="1em" textAlign="left" m="0.6em 0" padding="12px 0">
  <ListItem>
    üöÄ Les vues dispatchent les <b>actions aux reducers</b>
  </ListItem>
  <ListItem>
    üîÅ Les <b>reducers</b> modifient le store en fonction de l'action
  </ListItem>
  <ListItem>
    üöÄ Les stores renvoient les donn√©es aux <b>vues</b>
  </ListItem>
</List>

---

<SlideHeader slideTitle="Redux: r√©cap" />

#### R√©cap du flow

<Image
  src={require("./assets/schema.gif").default.src}
  alignSelf="center"
  width="70%"
/>

---

<SlideHeader slideTitle="Exemple Redux" />

```js
function counter(state = 0, action) {
  switch (action.type) {
    case "INCREMENT":
      return state + 1;
    case "DECREMENT":
      return state - 1;
    default:
      return state;
  }
}
var store = Redux.createStore(counter);
var valueEl = document.getElementById("value");

function render() {
  valueEl.innerHTML = store.getState().toString();
}

render();
store.subscribe(render);

document.getElementById("increment").addEventListener("click", function () {
  store.dispatch({ type: "INCREMENT" });
});
document.getElementById("decrement").addEventListener("click", function () {
  store.dispatch({ type: "DECREMENT" });
});
document
  .getElementById("incrementIfOdd")
  .addEventListener("click", function () {
    if (store.getState() % 2 !== 0) {
      store.dispatch({ type: "INCREMENT" });
    }
  });
```

---

<SlideHeader slideTitle="Redux" />

#### D√©tails d'impl√©mentation

- Composants de pr√©sentation: **affiche les donn√©es**
- Composant container: **li√©s au store et aux actions**
- S√©parer les diff√©rentes parties dans des fichiers (actions.js, reducers.js,
  store.js)

---

<SlideHeader slideTitle="Redux" />

#### Recommandations

- Redux est une proposition d'architecture et n'est pas obligatoire pour
  r√©aliser une application
- Elle permet de d√©crire l'√©tat de l'application juste avec des objets et
  tableaux
- D√©crire les changements sous forme d'objet

---

<SlideHeader slideTitle="Redux" />

#### Les avantages

<List fontSize="1em" textAlign="left" m="0.6em 0" padding="12px 0">
  <ListItem>
    <ListIcon as={MdCheckCircle} color="green.300" />
    Sauvegarder l'√©tat complet et relancer l'application de cette sauvegarde plus
    tard
  </ListItem>
  <ListItem>
    <ListIcon as={MdCheckCircle} color="green.300" />
    Serializer les actions utilisateurs et les lier √† des rapports de bug pour rejouer
    le parcours
  </ListItem>
  <ListItem>
    <ListIcon as={MdCheckCircle} color="green.300" />
    Facilit√© d'inspection et de debug (nombreux outils d'aide au d√©veloppement)
  </ListItem>
  <ListItem>
    <ListIcon as={MdCheckCircle} color="green.300" />
    Facilit√© pour changer de librairie d'interface gr√¢ce au d√©couplage
  </ListItem>
</List>

---

<SlideHeader slideTitle="Redux dev tools" />

###### <b>Extension chrome</b>

N√©cessite un middleware Redux dans l'application

<Image src={require("./assets/redux-dev-tools.png").default.src} height="65%" />

https://github.com/zalmoxisus/redux-devtools-extension

---

<SlideHeader slideTitle="Redux" />

#### **Utiliser Redux : ** toujours la m√™me routine

- Identifier les actions et les cr√©er
- Ajouter / modifier vos reducers
- Appeler vos actions depuis vos composants
- Connectez votre composants aux stores

---

<SlideHeader slideTitle="Impl√©mentation Redux" />

#### Brancher le provider Redux et le store ‚úÖ

```jsx
import React from "react";
import { render } from "react-dom";
import { Provider } from "react-redux";
import { createStore } from "redux";
import reducers from "./reducers";
import Chat from "./components/Chat";

let store = createStore(reducers);

render(
  <Provider store={store}>
    <Chat />
  </Provider>,
  document.getElementById("app")
);
```

---

<SlideHeader slideTitle="Le store Redux" />

#### Le composant Provider de Redux

- Donne √† vos composants l'acc√®s au store Redux

```jsx
render(
  <Provider store={store}>
    <App />
  </Provider>,
  document.getElementById("app")
);
```

---

<SlideHeader slideTitle="Le store Redux" />

#### Le store redux

- Le store est un objet JS contenant l‚Äô√©tat de votre application
- Pour le modifier on passe par un reducer qui va g√©n√©rer un nouvel √©tat
- Avec Redux, on cr√©e un store avec la fonction createStore :

```js
let store = createStore(reducers);
```

---

<SlideHeader slideTitle="Les actions Redux" />

#### Les actions redux

- C‚Äôest un simple objet JS
- Il a obligatoirement une propri√©t√© "type"
- Il peut avoir d'autres attributs (description, id‚Ä¶)

---

<SlideHeader slideTitle="Impl√©mentation Redux" />

#### Cr√©er les actions Redux ‚úÖ

```js
// actions/messages.js
export const addMessage = (message, username) => {
  return {
    type: "ADD_MESSAGE",
    message,
    username,
  };
};
```

---

<SlideHeader slideTitle="Les reducers Redux" />

#### Les reducers Redux

- Un reducer est une fonction pure, sans √©tat
- Il prend en param√®tre un state et une action, pour retourner un nouvel √©tat
- (state, action) => newState
- Il d√©crit comment une action va modifier un state donn√©
- Il consid√®re l‚Äôaction en param√®tre afin de cr√©er un nouvel √©tat

---

<SlideHeader slideTitle="Les reducers Redux" />

#### Les reducers Redux : fonctions pures

- Un reducer est d√©terministe (si on l‚Äôappelle 30 fois avec les m√™mes
  param√®tres, elle renvoie 30 fois le m√™me r√©sultat) ;
- Un reducer ne modifie pas ses param√®tres
- Un reducer ne modifie aucune autre ressource externe

---

<SlideHeader slideTitle="Impl√©mentation Redux" />

#### Cr√©er les reducers Redux ‚úÖ

```js
// reducers/message.js

const INITIAL_STATE = {
  entities: [],
};

const messages = (state = INITIAL_STATE, action) => {
  switch (action.type) {
    case "ADD_MESSAGE":
      return {
        entities: [
          ...state.entities,
          { body: action.message, username: action.username },
        ],
      };

    default:
      return state;
  }
};
```

---

<SlideHeader slideTitle="Impl√©mentation Redux" />

#### Combiner les reducers Redux ‚úÖ

```js
import { combineReducers } from "redux";
import messages from "./messages";

const reducers = combineReducers({
  messages,
});

export default reducers;
```

---

<SlideHeader slideTitle="Impl√©mentation Redux" />

#### La m√©thode connect()

- Pour qu‚Äôun composant React ait effectivement acc√®s au store, il faut le
  connecter au store
- On utilise la fonction
  **<a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#connectmapstatetoprops-mapdispatchtoprops-mergeprops-options">connect()</a>**
  de Redux sur le composant d√©sir√©

---

<SlideHeader slideTitle="Impl√©mentation Redux" />

#### Connectez vos composants (1/2) ‚úÖ

```jsx
import React from "react";
import { connect } from "react-redux";
import { addMessage } from "./actions/messages";

const mapStateToProps = (state) => {
  return {
    messages: state.messages.entities,
  };
};

const mapDispatchToProps = (dispatch) => {
  return {
    onAddMessage: (message, username) => {
      dispatch(addMessage(message, username));
    },
  };
};

const Chat = ({ messages, onAddMessage }) => {
  return <div>Chat</div>;
};

export default connect(mapStateToProps, mapDispatchToProps)(Chat);
```

---

<SlideHeader slideTitle="Impl√©mentation Redux" />

#### Connectez vos composants (1/2) ‚úÖ

- **mapStateToProps** : injecte le state de vos reducers dans les props de vos
  composants
- **mapDispatchToProps** : injecte les fonctions permettant de cr√©er les actions
  dans vos composants

---

<SlideHeader slideTitle="Redux et les hooks" />

#### Avec les hooks ‚öìÔ∏è

```jsx
import React from "react";
import { useDispatch, useSelector } from "react-redux";
import { addMessage } from "./actions/messages";

const Chat = () => {
  const dispatch = useDispatch();
  const messages = useSelector((state) => state.messages.entities);

  const message = "Hello";
  const username = "Toms";

  return (
    <div>
      <button onClick={() => dispatch(addMessage(message, username))}>
        Add message
      </button>
      Chat
    </div>
  );
};
```

---

<SlideHeader slideTitle="Redux : g√©rer ses fichiers" />

#### Redux : organiser les fichiers

- Il faut s√©parer dans des dossiers les diff√©rents √©lements :
  - Les reducers dans le dossier **/reducers**
  - Les actions dans le dossier **/actions**
  - Les constantes dans le dossier **/constants**

---

<SlideHeader slideTitle="Mise en pratique : Redux" />

##### üìêü§ì <b>Redux</b> : au boulot !

- http://redux.js.org/
- Ajouter la librairie **Redux** au JoliChat
- Passer l'ajout de message **en Redux**
  - Cr√©ation du reducer
  - Ajout de l'action
  - Connexion des composants

---

<SlideHeader slideTitle="Appel asynchrone Redux" />

#### G√©rer les appels asynchrones

- De base Redux ne g√®re pas les appels asynchrones
- Il faut utiliser la librairie
  [Redux Thunk](https://github.com/gaearon/redux-thunk)
- Permet de retourner une fonction ou une Promise au lieu de retourner une
  action
- On peut donc facilement appeler une API avec Fetch

---

<SlideHeader slideTitle="Appel asynchrone Redux" />

#### G√©rer les appels asynchrones

```js
function getMessages() {
  return (dispatch) => {
    dispatch({ type: GET_MESSAGES_PENDING });

    return fetch("https://api.example.com/message")
      .then((response) => response.json())
      .then((json) => {
        dispatch({ type: GET_MESSAGES_SUCCESS, messages: json.messages });
      })
      .catch((err) => dispatch({ type: GET_MESSAGES_ERROR, error: err }));
  };
}
```

---

<SlideHeader slideTitle="Mise en pratique : l'asynchrone avec Redux" />

##### üìêü§ì <b>Redux</b> : l'asynchrone avec Redux

- Ajouter la librairie **[Redux Thunk](https://github.com/gaearon/redux-thunk)**
  au JoliChat
- Utilisez
  https://my-json-server.typicode.com/tlenclos/formation-react-fake-server/messages
  et le client http [Axios](https://github.com/mzabriskie/axios)
- Initialiser le chat avec des messages
  - Cr√©er trois actions :
    - LOAD_MESSAGES_PENDING
    - LOAD_MESSAGES_SUCCESS
    - LOAD_MESSAGES_ERRO

</Slides>
